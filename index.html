<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <!--The viewport meta tag is used to improve the presentation and behavior of the samples
      on iOS devices-->
  <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
  <title>Select with feature layer</title>
  <link rel="stylesheet" href="http://js.arcgis.com/3.13/dijit/themes/tundra/tundra.css">
  <link rel="stylesheet" href="http://js.arcgis.com/3.13/esri/css/esri.css">
  <style>
    html,
    body,
    #mapDiv {
      padding: 0;
      margin: 0;
      height: 100%;
    }
    #messages {
      background-color: #fff;
      box-shadow: 0 0 5px #888;
      font-size: 1.1em;
      max-width: 15em;
      padding: 0.5em;
      position: absolute;
      right: 20px;
      top: 20px;
      z-index: 40;
    }
    .tundra .dijitSelect .dijitButtonText {
    	text-align: left;
    }

    .tundra .dijitSelectLabel {
    	width: 260px;
    	-moz-box-sizing: border-box;
    	overflow: hidden;
    }
  </style>
  <script src="http://js.arcgis.com/3.13/"></script>
  <script>
    dojoConfig = {
      parseOnLoad: true
    }
  </script>
  <script>
  var app = {}

    require([
      "esri/map", "esri/layers/FeatureLayer", "esri/request", "esri/arcgis/utils",
      "esri/tasks/query", "esri/tasks/RelationshipQuery",
      "esri/graphic", "esri/InfoTemplate", "esri/symbols/SimpleMarkerSymbol",
      "esri/symbols/SimpleLineSymbol", "esri/symbols/SimpleFillSymbol", "esri/renderers/SimpleRenderer",
      "dijit/form/Select", "dijit/form/Button",
      "dojo/_base/array", "dojo/_base/lang",
      "esri/config", "esri/Color", "dojo/on", "dojo/parser", "dojo/dom", "dojo/domReady!"
    ], function(
      Map, FeatureLayer, esriRequest, arcgisUtils,
      Query, RelationshipQuery,
      Graphic, InfoTemplate, SimpleMarkerSymbol,
      Select, Button,
      arrayUtils, lang,
      SimpleLineSymbol, SimpleFillSymbol, SimpleRenderer,
      esriConfig, Color, on, parser, dom
    ) {

      parser.parse();

      // use a proxy page if a URL generated by this page is greater than 2000 characters
      //
      // this should not be needed as nearly all query & select functions are performed on the client
      esriConfig.defaults.io.proxyUrl = "/proxy/";

      arcgisUtils.createMap("a5e032e9a65c41ae98dc56fc2c314a98", "map").then(function(response) {

        var map = response.map;
        var layers = response.itemInfo.itemData.operationalLayers;
        var tables = response.itemInfo.itemData.tables;

        cbLayers(layers, "layers")
        console.log(layers)
        var layerDom = dom.byId("layers")
        var layerId = layerDom.options[layerDom.selectedIndex].value
        var selectedLayer = map.getLayer(layerId)
        populateRels(selectedLayer, "relationships")
        console.log(selectedLayer)
        //cbLayerFields(selectedLayer, "l_field")
        myFields("l_field")
        var fieldDom = dom.byId("l_field")
        on(fieldDom, "change", function(evt){
          console.log(evt)
          var fieldDom = dom.byId("l_field")
          var field = fieldDom.options[fieldDom.selectedIndex].value
          console.log(field)
          getLayerValues(selectedLayer, field)

        })

        var valueDom = dom.byId("l_value");
        var showRelate = dom.byId("showRelate");

        on(showRelate, "click", function(){
          filterOnRelate(selectedLayer)
        })

        on(valueDom, "change", function(evt){
          //console.log(evt)
          //var fieldDom = dom.byId("l_field")
          var value = valueDom.options[valueDom.selectedIndex].value
          //var fieldDom = dom.byId("l_field")
          var field = fieldDom.options[fieldDom.selectedIndex].value
          var expression = field + "=" + "'" + value + "'"
          console.log(expression)
          selectedLayer.setDefinitionExpression(expression)

        })

      });

      function filterOnRelate(layer){

        //var layerDom = dom.byId("layers")
        //var layerId = layerDom.options[layerDom.selectedIndex].value
        //var selectedLayer = map.getLayer(layerId)
        var query = new Query();
        query.returnIdsOnly=true
        query.where = "1=1"
        layer.queryIds(query, function(objids){
          var relatedQuery = new RelationshipQuery();
          relatedQuery.objectIds = objids
          relatedQuery.returnGeometry = false
          relatedQuery.relationshipId = 0
          relatedQuery.outFields = ["*"]
          var field = dom.byId("t_field")
          var type = dom.byId("t_value")
          var myQuery = field.options[field.selectedIndex].value + "=" + "'" + type.options[type.selectedIndex].value + "'"

          relatedQuery.definitionExpression = myQuery
          layer.queryRelatedFeatures(relatedQuery, function(response){
          var feature;
          //console.log(response)
          var keys = [];
          for(var k in response) keys.push(k);
      var expression = "OBJECTID IN (" + keys + ")"
      layer.setDefinitionExpression(expression)
          })
        });
      }
      function cbLayers(layers, layerDom){
        var layerSelect = dom.byId(layerDom)
        var layerOptions = layerSelect.options;
        layerOptions.length = 0;

        //Loop through the layers and populate select

        dojo.forEach(layers, function(layer, i) {
          var title = layer.title;
          var layerId = layer.id
          layerOptions[i] = new Option(title, layerId)
        });

      }
      function populateRels(layer, relDom){
        var relSelect = dom.byId(relDom)
        var relOptions = relSelect.options;
        relOptions.length = 0;

        //Loop through the layers and populate select
        var relationships = layer.relationships

        dojo.forEach(relationships, function(rel, i) {
          var name = rel.name;
          var id = rel.id
          relOptions[i] = new Option(name, id)
        });

      }
      function cbValues(values, valueDom){
        var layerSelect = dom.byId(valueDom)
        var layerOptions = layerSelect.options;
        layerOptions.length = 0;

        //Loop through the layers and populate select
        //i = 1
        //layerOptions[i] = new Option("ALL", "ALL")

        dojo.forEach(values, function(value, i) {
          //i = i+1
          //var layerId = layer.id
          layerOptions[i] = new Option(value, value)
        });

      }
        function myFields(fieldDom){

          var fieldSelect = dom.byId(fieldDom)
          var fieldOptions = fieldSelect.options;
          var fields = [
          {"label":"Parish Name","fieldName":"Parish_Name"},
          {"label":"Pit Type","fieldName":"PIT_TYPE"}];

          dojo.forEach(fields, function(field, index) {

              var label = field.label;
              var fieldName = field.fieldName
              fieldOptions[index] = new Option(label, fieldName)
            });
        }
        function cbLayerFields(layer, fieldDom){

          var fieldSelect = dom.byId(fieldDom)
          var fieldOptions = fieldSelect.options;
          fieldOptions.length = 0;

          //Loop through the layers and populate select
          var index = -1
          dojo.forEach(layer.fields, function(field) {
            if (field.type == "esriFieldTypeString"){
              ++index
              var label = field.alias;
              var fieldName = field.Name
              fieldOptions[index] = new Option(label, fieldName)
            }

          });
      }
      function getLayerValues(layer, field){

        mQuery = new Query();
        // set up the parameters to query for the metals
        console.log(field + " is not null")
        mQuery.where = field + " is not null";
        mQuery.outFields = [field];
        //mQuery.returnDistinctValues = true
        mQuery.returnGeometry = false;
        layer.queryFeatures(mQuery, function(result){
          var features = result.features
          var values = getUniqueFieldValues(features, field)

          cbValues(values, "l_value")
        });
      }

      function getUniqueFieldValues(features, field){
        //Populate the ComboBox with unique values

        var field_value;
        var unique_values = [];
        var testVals = {};

        //Loop through the Query results and populate an array
        //with the unique values


        dojo.forEach(features, function(feature) {
          field_value = feature.attributes[field];

          if (!testVals[field_value]) {
            testVals[field_value] = true;
            unique_values.push(field_value)
          }
        });
        return unique_values
      }
    });
  </script>
</head>

<body class="tundra">
  <div id="messages">Query Related Metal Samples Table
    <div>
      <select id="layers"></select>
    </div>
    <div>
      <select id="l_field"></select>
      <select id="l_value">

      </select>
    </div>
    <div>
      <select id="relationships"></select>
    </div>
    <div>
      <select id="t_field">
        <option value="Metal">Metal</option>
      </select>
      <select id="t_value">
        <option value="Ag">Ag</option>
      </select>
    </div>
    <button id="showRelate" data-dojo-type="dijit.form.Button">Show Relate</button>
  </div>

  <div id="map"></div>
</body>

</html>
